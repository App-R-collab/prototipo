<script>
  function cargarUsuarios() {
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    const contenedor = document.getElementById("contenedorUsuarios");
    contenedor.innerHTML = "";

    if (usuarios.length === 0) {
      contenedor.innerHTML = "<p>No hay usuarios registrados a√∫n.</p>";
    } else {
      usuarios.forEach((u, index) => {
        const div = document.createElement("div");
        div.className = "usuario";
        div.innerHTML = `
          <div class="info">
            <strong>Nombre:</strong> ${u.nombre}<br>
            <strong>Correo:</strong> ${u.correo}<br>
            <strong>C√≥digo:</strong> ${u.codigo}<br>
            <strong>Referido por:</strong> ${u.referidoPor || 'Ninguno'}<br>
            <strong>L√≠nea:</strong> ${u.linea || 'No definida'}<br>
          </div>
          <div class="acciones">
            <button onclick="abrirModalEdicion(${index})">‚úèÔ∏è Modificar</button>
            <button onclick="eliminarUsuario(${index})">üóë Eliminar</button>
            <button onclick="mostrarArbol(${index})">üå≥ Ver √Årbol</button>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }
  }

  function eliminarUsuario(index) {
    if (confirm("¬øEst√°s seguro de eliminar este usuario?")) {
      const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
      usuarios.splice(index, 1);
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
      cargarUsuarios();
    }
  }

  function abrirModalEdicion(index) {
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    const u = usuarios[index];
    document.getElementById("edit-index").value = index;
    document.getElementById("edit-nombre").value = u.nombre;
    document.getElementById("edit-correo").value = u.correo;
    document.getElementById("edit-password").value = u.password || "";
    document.getElementById("edit-linea").value = u.linea || "";
    document.getElementById("modal-edicion").style.display = "flex";
  }

  function cerrarModalEdicion() {
    document.getElementById("modal-edicion").style.display = "none";
  }

  document.getElementById("form-edicion").addEventListener("submit", function(e) {
    e.preventDefault();
    const index = parseInt(document.getElementById("edit-index").value);
    const nombre = document.getElementById("edit-nombre").value.trim();
    const correo = document.getElementById("edit-correo").value.trim();
    const password = document.getElementById("edit-password").value;
    const linea = document.getElementById("edit-linea").value.trim();

    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    if (!usuarios[index]) return alert("Error interno");

    usuarios[index].nombre = nombre;
    usuarios[index].correo = correo;
    usuarios[index].password = password;
    usuarios[index].linea = linea;

    localStorage.setItem("usuarios", JSON.stringify(usuarios));
    cerrarModalEdicion();
    cargarUsuarios();
  });

  function construirArbol(codigo) {
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    const hijos = usuarios.filter(u => u.referidoPor === codigo);
    if (!hijos.length) return '';

    let html = '<ul>';
    hijos.forEach(hijo => {
      html += `<li><div>${hijo.nombre}</div>`;
      html += construirArbol(hijo.codigo);
      html += '</li>';
    });
    html += '</ul>';
    return html;
  }

  function mostrarArbol(index) {
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    const usuario = usuarios[index];
    const html = `
      <div class="tree">
        <ul>
          <li><div>${usuario.nombre}</div>
            ${construirArbol(usuario.codigo)}
          </li>
        </ul>
      </div>
    `;

    const modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = 0;
    modal.style.left = 0;
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.backgroundColor = "rgba(0,0,0,0.5)";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.style.zIndex = "9999";

    modal.innerHTML = `
      <div style="background: white; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; width: 95%; max-width: 600px;">
        <h3>√Årbol de ${usuario.nombre}</h3>
        ${html}
        <br>
        <button onclick="document.body.removeChild(this.parentElement.parentElement)" style="margin-top: 10px; background-color: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Cerrar</button>
      </div>
    `;

    document.body.appendChild(modal);
  }

  cargarUsuarios();
</script>
